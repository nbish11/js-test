/*!
 * Moovie - An advanced HTML5 video player for MooTools.
 * Copyright (c) 2010 Colin Aarts <colin@colinaarts.com>
 * Licensed MIT-style.
 */
!function(a){"use strict";var b=!(!document.createElement("video").canPlayType||!HTMLVideoElement),c=new Class({Implements:[Options],options:{debug:!1,container:null},initialize:function(a,d){var e,f;if(!b)throw new Error("Your browser does not support the video tag!");if(0===arguments.length)throw new Error("A video element or options object is required!");if("object"===typeOf(a)&&("src"in a||"sources"in a))d=Object.filter(a,function(a,b){return c.MediaAttributes.contains(b)?!1:!0}),a=Object.subset(a,c.MediaAttributes),this.video=new Element("video",a),"array"!==typeOf(d.sources)||"src"in a||(e=Array.map(d.sources,function(a){return new Element("source",a)}),delete d.sources,this.video.adopt(e),this.video.load()),"array"===typeOf(d.tracks)&&(f=Array.map(d.tracks,function(a){return"object"===typeOf(a)?new Element("track",a):void 0}),delete d.tracks,this.video.adopt(f)),this.setOptions(d);else{if(!document.id(a)||!instanceOf(document.id(a),HTMLVideoElement))throw new Error("The video could not be created or resolved!");this.video=document.id(a),this.setOptions(d)}this.bound={},this.build()},build:function(){return this.element=document.id(this.options.container)||new Element("div"),this.element.hasClass("moovie")||this.element.addClass("moovie"),this.controls={play:function(){return new Element("div.play",{})}(this),stop:function(){return new Element("div.stop",{})}(this),previous:function(){return new Element("div.previous",{})}(this),next:function(){return new Element("div.next",{})}(this),elapsed:function(){return new Element("div.elapsed",{})}(this),seekbar:function(){return new Element("div.seekbar",{})}(this),duration:function(){return new Element("div.duration",{})}(this),volume:function(){return new Element("div.volume",{})}(this),settings:function(){return new Element("div.settings",{})}(this),more:function(){return new Element("div.more",{})}(this),fullscreen:function(){return new Element("div.fullscreen",{})}(this)},this},load:function(a,b){return"string"===typeOf(a)&&this.video.set("src",a),"string"===typeOf(b)&&this.video.set("poster",b),this.video.load(),this},play:function(){return this.video.play(),this},pause:function(){return this.video.pause(),this},stop:function(a){this.video.pause();try{this.video.currentTime=0}catch(b){}return a&&this.video.load(),this},request:function(){return this},cancel:function(){return this}});a.Moovie=c}(this),function(a){"use strict";a.MediaAttributes=["autoplay","preload","controls","loop","poster","height","width","muted","mediagroup","src"]}(Moovie),function(a){"use strict";a.Playlist=new Class({Implements:[Events,Options],options:{disabled:!1,url:null,name:"",template:{"class":"active",html:"<p>{{title}}</p>"}},initialize:function(a){this.setOptions(a),this.element=new Element("ol.playlist"),this.bound={parse:this.parse.bind(this),prevent:this.prevent.bind(this),relay:this.relay.bind(this)},this.reset(),Object.defineProperties(this,{length:{enumerable:!0,get:function(){return this.itemData.length}}}),this.options.url&&this.load(this.options.url),this.options.disabled||this.attach()},reset:function(){return this.index=0,this.request=null,this.itemElements=new Elements,this.itemData=[],this.name=this.options.name,this.element.empty(),this},load:function(a){return this.request=new Request.JSON({method:"GET",url:a,async:!0,onSuccess:this.bound.parse}),this.request.send(),this},attach:function(){return this.element.addEvent("mousedown",this.bound.prevent),this.element.addEvent("click:relay(li)",this.bound.relay),this},detach:function(){return this.element.removeEvent("mousedown",this.bound.prevent),this.element.removeEvent("click:relay(li)",this.bound.relay),this},build:function(){var a=this.itemData.map(function(a,b){return new Element("li",{"class":b===this.index?"active":null,html:this.transform(this.options.template.html,a)})},this);return this.itemElements=new Elements(a),this.element.adopt(this.itemElements),this},parse:function(a){return this.itemData.combine(a),this.build(),this.fireEvent("load",[this.itemData,this.itemElements]),this},hasPrevious:function(){return this.index>0},previous:function(){return this.hasPrevious()&&this.select(this.index-1),this},hasNext:function(){return this.index<this.length-1},next:function(){return this.hasNext()&&this.select(this.index+1),this},select:function(a){return a=a.toInt(),a>=0&&a<=this.length-1&&(this.index=a,this.fireEvent("select",[this.current(),this.active()])),this},current:function(){return this.itemData[this.index]},active:function(){return this.itemElements.removeClass("active")[this.index].addClass("active")},toElement:function(){return this.element},prevent:function(a){return a.preventDefault(),!1},relay:function(a,b){return this.select(this.itemElements.indexOf(b)),this},transform:function(a,b){return a.replace(/{{(?:\s*(.*?)\s*(?:\|\|\s*(.*?)\s*)?)}}/g,function(a,c,d){return c in(b||{})?b[c]:"undefined"!=typeof d?d:""})}})}(Moovie);